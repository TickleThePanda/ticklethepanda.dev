<form id="weight-form">
  <h3>weight</h3>
  <div id="inputs">
    <input id="entry-date" name="entry-date" type="date" placeholder="date">
    <select id="entry-period" name="entry-period" placeholder="period">
      <option value="AM">AM</option>
      <option value="PM">PM</option>
    </select>
    <input name="entry-value" type="number" step="0.1" placeholder="weight">
    <input name="username" type="text" placeholder="username">
    <input name="password" type="password" placeholder="password">
    <input type="submit" value="Submit">
  </div>
  <div id="results">
    <div class="error">error: <span id="result-error"></span></div>
    <div class="success">date: <span id="result-date"></span></div>
    <div class="success">period: <span id="result-period"></span></div>
    <div class="success">weight: <span id="result-value"></span></div>
  </div>
</form>

<div id="weight-history">

</div>

<script>
  (function setupTime() {
    function getMiddayOfDate(date) {
      var middayOnDate = new Date(date);
      middayOnDate.setHours(12);
      middayOnDate.setMinutes(0);
      middayOnDate.setSeconds(0);
      middayOnDate.setMilliseconds(0);

      return middayOnDate;
    }
    var now = new Date();
    var middayToday = getMiddayOfDate(now);
    
    document.getElementById('entry-date').value = now.toISOString().substring(0,10);

    if(now < middayToday) {
      document.getElementById("entry-period").value = "AM";
    } else {
      document.getElementById("entry-period").value = "PM";
    }

  })();
</script>

<script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous">
</script>

<script>
  $(document).ready(function() {
    function loadWeightHistory() {
      $("#weight-history").empty();
      fetch("https://api.ticklethepanda.co.uk/health/weight")
        .then(response => {
          if(response.ok) {
            return response.json();
          } else {
            throw Error("unable to load data: " + response.statusText);
          }
        })
        .then(results => {

          function cleanWeightResult(weight) {
            if(weight) {
              return weight.toFixed(1);
            } else {
              return "-";
            }
          }

          var $table = $("<table>").append(
            $("<thead>")
              .append(
                $("<tr>")
                  .append($("<th>date</th>"))
                  .append($("<th>am</th>"))
                  .append($("<th>pm</th>"))
            )
          );

          var $tableBody = $("<tbody>")
          $table.append($tableBody);

          results.reverse();
        
          results.forEach(result => {
            var $row = $("<tr>");

            var date = new Date(result.date[0], result.date[1], result.date[2]);
            var dateString = date.toISOString().substring(0,10);

            $row.append($(`<td>${dateString}</td>`));
            $row.append($(`<td>${cleanWeightResult(result.weightAm)}</td>`));
            $row.append($(`<td>${cleanWeightResult(result.weightPm)}</td>`));

            $tableBody.append($row);
          });
          $("#weight-history").append($table);
        });
    }

    loadWeightHistory();

    $("#weight-form").submit(function(e) {
      e.preventDefault();
      var form = $(this).serializeArray();

      var values = form.reduce((a, b) => {
	a[b.name] = b.value
        return a;
      }, {});
      
      var url = `https://api.ticklethepanda.co.uk/health/weight/${values["entry-date"]}/${values["entry-period"]}`;
      var payload = { weight: values["entry-value"] };
      
      var headers = new Headers({
        "Authorization": "Basic " + btoa(values["username"] + ":" + values["password"]),
        "Content-Type": "application/json"
      });

      var init = { method: 'PUT',
         headers: headers,
         mode: 'cors',
         body: JSON.stringify(payload)
      }
      
      fetch(url, init)
        .then(response => {
          if(response.ok) {
            return response.json();
          } else {
            throw Error("unable submit data: " + response.statusText);
          }
        })
        .then(result => {
          var date = result.localDate[0] + "-"
                      + result.localDate[1] + "-"
                      + result.localDate[2];
          $("#result-date").text(date);
          $("#result-period").text(result.entryPeriod);
          $("#result-value").text(result.weight);

          $("#results").removeClass("error");
          $("#results").addClass("success");
        })
        .catch(error => {
          $("#result-error").text(error.message);

          $("#results").removeClass("success");
          $("#results").addClass("error");
        })
        .then(loadWeightHistory);

    });
  });
</script>

<style>
  form#weight-form {
    border: 1px solid black;
  }

  form#weight-form h3 {
    margin-left: 1em;
  }

  form#weight-form > #inputs * {
    display: block;
    margin-left: 1em;
    margin-bottom: 1em;
  }

  form#weight-form input[name="entry-date"], form#weight-form > select[name="entry-period"] {
    display: inline;
  }

  #results {
    display: none;
    margin: 0.5em;
    padding: 0.5em
  }

  #results .success, #results .error {
    display: none;
  }

  #results.success, #results.error {
    display: block;
  }

  #results.success {
    background-color: #E6F7C4;
  }

  #results.error {
    background-color: #F7C3CC;
  }

  #results.success > .success {
    display: block;
  }

  #results.error > .error {
    display: block;
  }

  #weight-history table {
    width: 100%
  }

  #weight-history thead th {
    background-color: #E6F7C4;
    border-bottom: #ccc solid 1px; 
  }

  #weight-history tbody tr:nth-child(even) {
    background-color: #eee;
  }

  #weight-history th, #weight-history td {
    padding: 1em;
  }
</style>
